<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>RoofPro Calculator - Interactive Experience</title>

    <!-- External CSS dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #FF6B35;
            --primary-dark: #E85A2C;
            --primary-light: #FF8A5B;
            --secondary: #004E89;
            --secondary-dark: #003D6B;
            --secondary-light: #0066B8;
            --accent: #F7931E;
            --success: #00D9A3;
            --warning: #FFB800;
            --error: #FF3B30;
            --dark: #1A1A1A;
            --light: #FFFFFF;
            --gray-50: #FAFBFC;
            --gray-100: #F8F9FA;
            --gray-200: #E9ECEF;
            --gray-300: #DEE2E6;
            --gray-400: #CED4DA;
            --gray-500: #ADB5BD;
            --gray-600: #6C757D;
            --gray-700: #495057;
            --gray-800: #343A40;
            --gray-900: #212529;


            
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.12);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.16);
            --shadow-xl: 0 16px 48px rgba(0,0,0,0.2);
            
            --transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --radius-full: 9999px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark);
            color: var(--light);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
        }

        /* CRITICAL: Hidden class definition */
        .hidden {
            display: none !important;
        }

        /* Animated Neutral Background */
        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: #ffffff;
            overflow: hidden;
        }

        /* Geometric Grid Background */
        .grid-bg {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: grid-move 20s linear infinite;
        }

        @keyframes grid-move {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        /* Floating Geometric Shapes */
        .geo-shape {
            position: absolute;
            opacity: 0.05;
            animation: float-rotate 20s infinite ease-in-out;
        }

        .geo-shape:nth-child(1) {
            width: 300px;
            height: 300px;
            background: rgba(255, 107, 53, 0.05);
            clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%);
            top: 10%;
            left: 10%;
            animation-duration: 25s;
        }

        .geo-shape:nth-child(2) {
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.02);
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            bottom: 20%;
            right: 15%;
            animation-duration: 30s;
            animation-delay: -5s;
        }

        .geo-shape:nth-child(3) {
            width: 250px;
            height: 250px;
            background: rgba(247, 147, 30, 0.05);
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-duration: 35s;
            animation-delay: -10s;
        }

        @keyframes float-rotate {
            0%, 100% { 
                transform: rotate(0deg) scale(1) translateY(0);
                opacity: 0.05;
            }
            25% { 
                transform: rotate(90deg) scale(1.1) translateY(-30px);
                opacity: 0.08;
            }
            50% { 
                transform: rotate(180deg) scale(0.9) translateY(20px);
                opacity: 0.03;
            }
            75% { 
                transform: rotate(270deg) scale(1.05) translateY(-10px);
                opacity: 0.06;
            }
        }

        /* Map Container */
        #map {
            height: 100vh;
            width: 100%;
            position: relative;
            z-index: 10;
        }

        /* Modern Card Design - Simple White */
        .overlay-card {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-xl);
            padding: 2.5rem;
            width: calc(100% - 2rem);
            max-width: 520px;
            box-shadow: var(--shadow-xl);
            z-index: 100;
            color: var(--dark);
            animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Step Header */
        .step-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: var(--secondary);
            border-radius: var(--radius-lg);
            font-weight: 700;
            font-size: 1.25rem;
            color: white;
            margin-bottom: 1rem;
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .step-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .step-subtitle {
            color: var(--gray-600);
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Modern Search Input */
        .search-container {
            position: relative;
            margin: 2rem 0;
        }

        .search-input-wrapper {
            position: relative;
            border: 2px solid var(--primary);
            border-radius: var(--radius-lg);
            transition: var(--transition-base);
        }

        .search-input-wrapper:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-dark);
        }

        .search-input {
            width: 100%;
            padding: 1.25rem 1.25rem 1.25rem 3.5rem;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 500;
            background: white;
            color: var(--dark);
            transition: var(--transition-base);
        }

        .search-input:focus {
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.25rem;
            z-index: 1;
        }

        /* Autocomplete Results */
        .autocomplete-results {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            right: 0;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
            animation: fadeIn 0.3s ease-out;
            z-index: 1000;
        }

        .autocomplete-item {
            padding: 1rem 1.25rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--gray-700);
            border-bottom: 1px solid var(--gray-100);
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .autocomplete-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: translateX(-100%);
            transition: var(--transition-fast);
        }

        .autocomplete-item:hover {
            background: var(--gray-50);
            padding-left: 2rem;
            color: var(--dark);
        }

        .autocomplete-item:hover::before {
            transform: translateX(0);
        }

        /* Modern Radio Buttons - Simple */
        .radio-group {
            display: grid;
            gap: 1rem;
            margin: 2rem 0;
        }

        .radio-card {
            position: relative;
            background: white;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition-base);
            overflow: hidden;
        }

        .radio-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .radio-card.selected {
            border-color: var(--secondary);
            background: var(--gray-50);
            box-shadow: var(--shadow-md);
        }

        .radio-content {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .radio-icon {
            width: 48px;
            height: 48px;
            background: var(--gray-100);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
            transition: var(--transition-base);
        }

        .radio-card.selected .radio-icon {
            background: var(--secondary);
            color: white;
        }

        .radio-label {
            flex: 1;
        }

        .radio-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .radio-description {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .radio-card input[type="radio"] {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        /* Modern Buttons - Simple Solid Colors */
        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 1.25rem 2rem;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition-base);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            width: 100%;
            padding: 1.25rem;
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            font-size: 1rem;
            background: white;
            color: var(--dark);
            transition: var(--transition-base);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,107,53,0.1);
        }

        /* Loading Animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition-base);
        }

        .loading-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .loader {
            position: relative;
            width: 80px;
            height: 80px;
        }

        .loader-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: rotate 1s linear infinite;
        }

        .loader-circle:nth-child(2) {
            width: 60px;
            height: 60px;
            top: 10px;
            left: 10px;
            border-top-color: var(--secondary);
            animation-duration: 0.8s;
            animation-direction: reverse;
        }

        .loader-circle:nth-child(3) {
            width: 40px;
            height: 40px;
            top: 20px;
            left: 20px;
            border-top-color: var(--accent);
            animation-duration: 0.6s;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Result Cards */
        .result-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: var(--transition-base);
            border: 1px solid var(--gray-200);
        }

        .result-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .result-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .result-icon {
            width: 48px;
            height: 48px;
            background: var(--secondary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .result-title {
            flex: 1;
            font-weight: 600;
            color: var(--dark);
        }

        .result-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Success Animation */
        .success-animation {
            text-align: center;
            padding: 3rem 0;
        }

        .success-icon-wrapper {
            position: relative;
            display: inline-block;
            width: 120px;
            height: 120px;
            margin-bottom: 2rem;
        }

        .success-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid var(--success);
            border-radius: 50%;
            animation: scaleIn 0.6s ease-out;
        }

        .success-checkmark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3rem;
            color: var(--success);
            animation: checkmarkIn 0.8s ease-out 0.3s both;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        @keyframes checkmarkIn {
            from {
                transform: translate(-50%, -50%) scale(0) rotate(-360deg);
                opacity: 0;
            }
            to {
                transform: translate(-50%, -50%) scale(1) rotate(0);
                opacity: 1;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(26, 26, 26, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition-base);
            padding: 1rem;
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-xl);
            padding: 3rem;
            width: 100%;
            max-width: 500px;
            box-shadow: var(--shadow-xl);
            transform: scale(0.9);
            transition: var(--transition-base);
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--gray-200);
        }

        .modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .modal-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            color: var(--gray-600);
        }

        /* Static Map Container */
        #staticLeafletMap {
            width: 100%;
            height: 300px;
            border-radius: var(--radius-lg);
            overflow: hidden;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--gray-300);
        }

        /* Mobile Responsive Improvements */
        @media (max-width: 768px) {
            body {
                padding-bottom: 0;
            }

            .overlay-card {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                transform: none;
                border-radius: var(--radius-xl) var(--radius-xl) 0 0;
                max-width: 100%;
                width: 100%;
                padding: 1.5rem;
                max-height: 80vh;
                overflow-y: auto;
                animation: slideUpMobile 0.6s ease-out;
                background: white;
                border: 1px solid var(--gray-200);
            }

            @keyframes slideUpMobile {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }

            .step-title {
                font-size: 1.5rem;
            }

            .step-subtitle {
                font-size: 0.9rem;
            }

            .button-group {
                flex-direction: column;
                gap: 0.75rem;
            }

            .btn {
                width: 100%;
                padding: 1rem 1.5rem;
                font-size: 0.9rem;
            }

            /* Improved search container for mobile */
            .search-container {
                position: static;
                margin: 1.5rem 0;
            }

            .search-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 1rem 1rem 1rem 3rem;
            }

            .autocomplete-results {
                position: fixed;
                top: auto;
                bottom: 100px;
                left: 1rem;
                right: 1rem;
                max-height: 40vh;
                z-index: 1001;
                box-shadow: var(--shadow-xl);
            }

            .radio-card {
                padding: 1.25rem;
            }

            .radio-icon {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }

            .radio-title {
                font-size: 1rem;
            }

            .radio-description {
                font-size: 0.8rem;
            }

            .modal-content {
                padding: 2rem;
                margin: 1rem;
            }

            .modal-title {
                font-size: 1.5rem;
            }

            #staticLeafletMap {
                height: 250px;
            }

            .step-number {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            /* Ensure map doesn't overlap with form */
            #map {
                height: 50vh;
            }
        }

        @media (max-width: 480px) {
            .overlay-card {
                padding: 1.25rem;
            }

            .step-title {
                font-size: 1.25rem;
            }

            .btn {
                padding: 0.875rem 1.25rem;
                font-size: 0.875rem;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: var(--radius-full);
        }

        /* iOS specific fixes */
        @supports (-webkit-touch-callout: none) {
            .overlay-card {
                padding-bottom: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg">
        <div class="grid-bg"></div>
        <div class="geo-shape"></div>
        <div class="geo-shape"></div>
        <div class="geo-shape"></div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Step 1: Address Search -->
    <div class="overlay-card" id="step1">
        <div class="step-header">
            <div class="step-number">1</div>
            <h2 class="step-title">Find Your Property</h2>
            <p class="step-subtitle">Start by entering your complete address below</p>
        </div>

        <div class="search-container">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input
                    type="text"
                    id="search"
                    class="search-input"
                    placeholder="Type your address here..."
                    autocomplete="off"
                />
            </div>
            <div class="autocomplete-results hidden" id="autocomplete-list"></div>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" disabled>
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <button class="btn btn-primary" id="nextBtn1" disabled>
                Continue
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Step 2: Adjust Location -->
    <div class="overlay-card hidden" id="step2">
        <div class="step-header">
            <div class="step-number">2</div>
            <h2 class="step-title">Perfect Your Location</h2>
            <p class="step-subtitle" id="selected-address-text"></p>
            <p class="step-subtitle">Drag the marker to the center of your roof</p>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="backBtn2">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <button class="btn btn-primary" id="nextBtn2">
                Continue
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Step 3: Ownership -->
    <div class="overlay-card hidden" id="step3">
        <div class="step-header">
            <div class="step-number">3</div>
            <h2 class="step-title">Property Ownership</h2>
            <p class="step-subtitle">Are you the owner of this property?</p>
        </div>

        <div class="radio-group">
            <label class="radio-card" data-value="Yes">
                <input type="radio" name="ownership" value="Yes" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Yes, I Own This Property</div>
                        <div class="radio-description">I'm the homeowner</div>
                    </div>
                </div>
            </label>
            <label class="radio-card" data-value="No">
                <input type="radio" name="ownership" value="No" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">No, I Rent This Property</div>
                        <div class="radio-description">I'm a tenant</div>
                    </div>
                </div>
            </label>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="backBtn3">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <button class="btn btn-primary" id="nextBtn3">
                Continue
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Step 4: Roof Type -->
    <div class="overlay-card hidden" id="step4">
        <div class="step-header">
            <div class="step-number">4</div>
            <h2 class="step-title">Select Your Roof Type</h2>
            <p class="step-subtitle">What style is your roof?</p>
        </div>

        <div class="radio-group">
            <label class="radio-card" data-value="Flat">
                <input type="radio" name="roofType" value="Flat" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-square"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Flat Roof</div>
                        <div class="radio-description">Minimal or no slope</div>
                    </div>
                </div>
            </label>
            <label class="radio-card" data-value="Sloped">
                <input type="radio" name="roofType" value="Sloped" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-mountain"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Sloped Roof</div>
                        <div class="radio-description">Traditional angled roof</div>
                    </div>
                </div>
            </label>
            <label class="radio-card" data-value="Tiled">
                <input type="radio" name="roofType" value="Tiled" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-th"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Tiled Roof</div>
                        <div class="radio-description">Clay or concrete tiles</div>
                    </div>
                </div>
            </label>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="backBtn4">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <button class="btn btn-primary" id="nextBtn4">
                Continue
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Step 5: Roofing Material -->
    <div class="overlay-card hidden" id="step5">
        <div class="step-header">
            <div class="step-number">5</div>
            <h2 class="step-title">Choose Your Material</h2>
            <p class="step-subtitle">Select your preferred roofing material</p>
        </div>

        <div class="radio-group">
            <label class="radio-card" data-value="Asphalt shingles">
                <input type="radio" name="roofMaterial" value="Asphalt shingles" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-layer-group"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Asphalt Shingles</div>
                        <div class="radio-description">Most popular & affordable</div>
                    </div>
                </div>
            </label>
            <label class="radio-card" data-value="Wood shake/composite">
                <input type="radio" name="roofMaterial" value="Wood shake/composite" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-tree"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Wood Shake/Composite</div>
                        <div class="radio-description">Natural & aesthetic appeal</div>
                    </div>
                </div>
            </label>
            <label class="radio-card" data-value="Metal">
                <input type="radio" name="roofMaterial" value="Metal" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Metal Roofing</div>
                        <div class="radio-description">Durable & energy efficient</div>
                    </div>
                </div>
            </label>
            <label class="radio-card" data-value="Tile">
                <input type="radio" name="roofMaterial" value="Tile" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-shapes"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Tile Roofing</div>
                        <div class="radio-description">Long-lasting & elegant</div>
                    </div>
                </div>
            </label>
            <label class="radio-card" data-value="Flat, foam, single ply">
                <input type="radio" name="roofMaterial" value="Flat, foam, single ply" />
                <div class="radio-content">
                    <div class="radio-icon">
                        <i class="fas fa-grip-horizontal"></i>
                    </div>
                    <div class="radio-label">
                        <div class="radio-title">Flat/Foam/Single Ply</div>
                        <div class="radio-description">For flat roof systems</div>
                    </div>
                </div>
            </label>
        </div>

        <div class="button-group">
            <button class="btn btn-secondary" id="backBtn5">
                <i class="fas fa-arrow-left"></i>
                Back
            </button>
            <button class="btn btn-primary" id="nextBtn5">
                Continue
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal" id="userDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Almost There!</h3>
                <p class="modal-subtitle">Just need your contact details to send the estimate</p>
            </div>

            <form id="userDetailsForm">
                <div class="form-group">
                    <label class="form-label" for="userName">Full Name</label>
                    <input
                        type="text"
                        id="userName"
                        class="form-input"
                        placeholder="John Doe"
                        required
                    />
                </div>

                <div class="form-group">
                    <label class="form-label" for="userEmail">Email Address</label>
                    <input
                        type="email"
                        id="userEmail"
                        class="form-input"
                        placeholder="john@example.com"
                        required
                    />
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" id="backBtnModal">
                        <i class="fas fa-arrow-left"></i>
                        Back
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Get My Quote
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Modal -->
    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <div class="step-header">
                <div class="step-number">6</div>
                <h2 class="step-title">Your Roof Analysis</h2>
            </div>

            <div id="staticLeafletMap"></div>

            <div class="result-card">
                <div class="result-header">
                    <div class="result-icon">
                        <i class="fas fa-ruler-combined"></i>
                    </div>
                    <div class="result-title">Estimated Roof Area</div>
                </div>
                <div class="result-value" id="roofAreaDisplay">Calculating...</div>
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" id="backBtnResults">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </button>
                <button class="btn btn-primary" id="calculateCostBtn">
                    Calculate Cost
                    <i class="fas fa-calculator"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Cost Estimate Modal -->
    <div class="modal" id="costModal">
        <div class="modal-content">
            <div class="step-header">
                <h2 class="step-title">Your Roofing Estimate</h2>
            </div>

            <div id="costBreakdown"></div>

            <p style="text-align: center; color: var(--gray-600); font-style: italic; margin-top: 1.5rem;">
                *This is an estimate. Final costs may vary based on actual conditions.
            </p>

            <div class="button-group">
                <button class="btn btn-secondary" id="backBtnCost">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </button>
                <button class="btn btn-primary" id="sendEmailBtn">
                    Email Me This Quote
                    <i class="fas fa-envelope"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="success-animation">
                <div class="success-icon-wrapper">
                    <div class="success-circle"></div>
                    <i class="fas fa-check success-checkmark"></i>
                </div>
                <h2 class="step-title">Success!</h2>
                <p class="step-subtitle">Your roofing estimate has been sent to your email</p>
                <p class="step-subtitle">We'll be in touch soon with more details</p>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="location.reload()">
                    Start New Estimate
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loader">
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
            <div class="loader-circle"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        // Initialize map
        const map = L.map("map").setView([48.8584, 2.2945], 13);
        L.tileLayer("https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", {
            maxZoom: 20,
            subdomains: ["mt0", "mt1", "mt2", "mt3"],
            attribution: "Map data © Google",
        }).addTo(map);

        // Custom marker
        let marker = L.marker([48.8584, 2.2945], {
            draggable: true,
            icon: L.divIcon({
                className: 'custom-marker',
                html: '<div style="background: #FF6B35; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 2px solid white;"></div>',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
            }),
        }).addTo(map);

        // State management
        let selectedLocation = null;
        let currentStep = 1;
        let userData = {
            ownership: null,
            roofType: null,
            roofMaterial: null,
            userName: '',
            userEmail: '',
            roofArea: 0,
            totalCost: 0
        };

        // DOM Elements
        const steps = {
            1: document.getElementById('step1'),
            2: document.getElementById('step2'),
            3: document.getElementById('step3'),
            4: document.getElementById('step4'),
            5: document.getElementById('step5')
        };

        const modals = {
            userDetails: document.getElementById('userDetailsModal'),
            results: document.getElementById('resultsModal'),
            cost: document.getElementById('costModal'),
            success: document.getElementById('successModal'),
            loading: document.getElementById('loadingOverlay')
        };

        const searchInput = document.getElementById('search');
        const autocompleteList = document.getElementById('autocomplete-list');

        // Step navigation
        function showStep(stepNumber) {
            Object.values(steps).forEach(step => step.classList.add('hidden'));
            if (steps[stepNumber]) {
                steps[stepNumber].classList.remove('hidden');
            }
            currentStep = stepNumber;
        }

        // Modal functions
        function showModal(modalName) {
            modals[modalName].classList.add('active');
        }

        function hideModal(modalName) {
            modals[modalName].classList.remove('active');
        }

        // Loading functions
        function showLoading() {
            modals.loading.classList.add('active');
        }

        function hideLoading() {
            modals.loading.classList.remove('active');
        }

        // Address search functionality
        let searchTimeout = null;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();

            if (query.length < 3) {
                autocompleteList.classList.add('hidden');
                autocompleteList.innerHTML = '';
                document.getElementById('nextBtn1').disabled = true;
                return;
            }

            searchTimeout = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&addressdetails=1&limit=5`)
                    .then(response => response.json())
                    .then(data => {
                        autocompleteList.innerHTML = '';
                        autocompleteList.classList.remove('hidden');
                        
                        data.forEach(item => {
                            const div = document.createElement('div');
                            div.className = 'autocomplete-item';
                            div.textContent = item.display_name;
                            div.addEventListener('click', () => {
                                selectedLocation = {
                                    text: item.display_name,
                                    lat: parseFloat(item.lat),
                                    lon: parseFloat(item.lon)
                                };
                                searchInput.value = item.display_name;
                                autocompleteList.classList.add('hidden');
                                document.getElementById('nextBtn1').disabled = false;
                                
                                // Update map
                                map.setView([selectedLocation.lat, selectedLocation.lon], 19);
                                marker.setLatLng([selectedLocation.lat, selectedLocation.lon]);
                            });
                            autocompleteList.appendChild(div);
                        });
                    });
            }, 400);
        });

        // Radio card selection
        document.querySelectorAll('.radio-card').forEach(card => {
            card.addEventListener('click', () => {
                const radioGroup = card.querySelector('input[type="radio"]');
                const groupName = radioGroup.name;
                
                // Clear other selections in the same group
                document.querySelectorAll(`input[name="${groupName}"]`).forEach(input => {
                    input.closest('.radio-card').classList.remove('selected');
                });
                
                // Select this card
                card.classList.add('selected');
                radioGroup.checked = true;
                
                // Update user data
                userData[groupName] = radioGroup.value;
            });
        });

        // Step 1 Navigation
        document.getElementById('nextBtn1').addEventListener('click', () => {
            if (!selectedLocation) return;
            document.getElementById('selected-address-text').textContent = selectedLocation.text;
            showStep(2);
        });

        // Step 2 Navigation
        document.getElementById('backBtn2').addEventListener('click', () => showStep(1));
        document.getElementById('nextBtn2').addEventListener('click', () => {
            const pos = marker.getLatLng();
            selectedLocation.lat = pos.lat;
            selectedLocation.lon = pos.lng;
            showStep(3);
        });

        // Step 3 Navigation
        document.getElementById('backBtn3').addEventListener('click', () => showStep(2));
        document.getElementById('nextBtn3').addEventListener('click', () => {
            if (!userData.ownership) {
                alert('Please select your ownership status');
                return;
            }
            showStep(4);
        });

        // Step 4 Navigation
        document.getElementById('backBtn4').addEventListener('click', () => showStep(3));
        document.getElementById('nextBtn4').addEventListener('click', () => {
            if (!userData.roofType) {
                alert('Please select your roof type');
                return;
            }
            showStep(5);
        });

        // Step 5 Navigation
        document.getElementById('backBtn5').addEventListener('click', () => showStep(4));
        document.getElementById('nextBtn5').addEventListener('click', () => {
            if (!userData.roofMaterial) {
                alert('Please select your roofing material');
                return;
            }
            showModal('userDetails');
        });

        // User Details Form
        document.getElementById('backBtnModal').addEventListener('click', () => {
            hideModal('userDetails');
        });

        document.getElementById('userDetailsForm').addEventListener('submit', (e) => {
            e.preventDefault();
            userData.userName = document.getElementById('userName').value;
            userData.userEmail = document.getElementById('userEmail').value;
            
            hideModal('userDetails');
            showModal('results');
            initStaticMap();
        });

        // Static map initialization
        let staticMap = null;
        function initStaticMap() {
            if (staticMap) staticMap.remove();
            
            staticMap = L.map('staticLeafletMap', {
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                tap: false,
                touchZoom: false,
            }).setView([selectedLocation.lat, selectedLocation.lon], 19);

            L.tileLayer("https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", {
                maxZoom: 20,
                subdomains: ["mt0", "mt1", "mt2", "mt3"],
            }).addTo(staticMap);

            L.marker([selectedLocation.lat, selectedLocation.lon], {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #FF6B35; width: 32px; height: 32px; border-radius: 50% 50% 50% 0; transform: rotate(-45deg); box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 2px solid white;"></div>',
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                }),
            }).addTo(staticMap);

            // Fetch building footprint
            showLoading();
            fetchBuildingFootprint(selectedLocation.lat, selectedLocation.lon)
                .then(building => {
                    const geojsonPolygon = convertToGeoJSONPolygon(building);
                    const areaSqMeters = turf.area(geojsonPolygon);
                    const areaSqFeet = areaSqMeters * 10.7639;
                    
                    userData.roofArea = areaSqFeet;
                    
                    const latlngs = building.geometry.map(coord => [coord.lat, coord.lon]);
                    L.polygon(latlngs, {
                        color: '#004E89',
                        fillColor: '#004E89',
                        fillOpacity: 0.3,
                        weight: 3
                    }).addTo(staticMap);
                    
                    document.getElementById('roofAreaDisplay').textContent = `${areaSqFeet.toFixed(2)} sq ft`;
                    hideLoading();
                })
                .catch(error => {
                    console.error(error);
                    document.getElementById('roofAreaDisplay').textContent = 'Unable to calculate';
                    hideLoading();
                });
            
            staticMap.invalidateSize();
        }

        // Calculate cost
        document.getElementById('calculateCostBtn').addEventListener('click', () => {
            if (!userData.roofArea) {
                alert('Unable to calculate cost without roof area');
                return;
            }
            
            const costPerSqFt = {
                'asphalt shingles': 3.5,
                'metal': 7.0,
                'tile': 10.0,
                'wood shake/composite': 8.5,
                'flat, foam, single ply': 4.5
            };
            
            const materialCost = costPerSqFt[userData.roofMaterial.toLowerCase()] || 5.0;
            userData.totalCost = materialCost * userData.roofArea;
            
            // Display cost breakdown
            const costBreakdown = document.getElementById('costBreakdown');
            costBreakdown.innerHTML = `
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-icon">
                            <i class="fas fa-ruler-combined"></i>
                        </div>
                        <div class="result-title">Roof Area</div>
                    </div>
                    <div class="result-value">${userData.roofArea.toFixed(2)} sq ft</div>
                </div>
                
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-icon">
                            <i class="fas fa-hammer"></i>
                        </div>
                        <div class="result-title">Material: ${userData.roofMaterial}</div>
                    </div>
                    <div class="result-value">$${materialCost.toFixed(2)}/sq ft</div>
                </div>
                
                <div class="result-card">
                    <div class="result-header">
                        <div class="result-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                        <div class="result-title">Total Estimate</div>
                    </div>
                    <div class="result-value">$${userData.totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
            `;
            
            hideModal('results');
            showModal('cost');
        });

        // Back buttons for modals
        document.getElementById('backBtnResults').addEventListener('click', () => {
            hideModal('results');
            showModal('userDetails');
        });

        document.getElementById('backBtnCost').addEventListener('click', () => {
            hideModal('cost');
            showModal('results');
        });

        // Send email
        document.getElementById('sendEmailBtn').addEventListener('click', () => {
            showLoading();
            sendEmail();
        });

        function sendEmail() {
            emailjs.init("MvtKEqySbMLzmvhWu");
            
            const templateParams = {
                from_name: userData.userName,
                roof_cost: `$${userData.totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`,
                reply_to: userData.userEmail,
                user_choices: `
                    Property: ${selectedLocation.text}
                    Ownership: ${userData.ownership}
                    Roof Type: ${userData.roofType}
                    Material: ${userData.roofMaterial}
                    Area: ${userData.roofArea.toFixed(2)} sq ft
                    Total: $${userData.totalCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                `,
                message: "New roofing estimate request"
            };
            
            emailjs.send("service_nv5ys5a", "template_s84mvdm", templateParams)
                .then(() => {
                    hideLoading();
                    hideModal('cost');
                    showModal('success');
                })
                .catch((error) => {
                    hideLoading();
                    console.error(error);
                    alert('Failed to send email. Please try again.');
                });
        }

        // Utility functions
        function fetchBuildingFootprint(lat, lon) {
            const overpassUrl = "https://overpass-api.de/api/interpreter";
            const query = `
                [out:json];
                (
                    way["building"](around:50,${lat},${lon});
                );
                out geom;
            `;

            return fetch(overpassUrl, {
                method: "POST",
                body: query,
            })
            .then(response => response.json())
            .then(data => {
                if (!data.elements || data.elements.length === 0) {
                    throw new Error("No buildings found");
                }

                const point = turf.point([lon, lat]);

                for (const element of data.elements) {
                    const polygon = convertToGeoJSONPolygon(element);
                    if (polygon && turf.booleanPointInPolygon(point, polygon)) {
                        return element;
                    }
                }

                return data.elements[0];
            });
        }

        function convertToGeoJSONPolygon(element) {
            if (!element || !element.geometry || element.geometry.length === 0) {
                return null;
            }

            const coordinates = element.geometry.map(coord => [coord.lon, coord.lat]);

            if (coordinates.length > 0 &&
                (coordinates[0][0] !== coordinates[coordinates.length - 1][0] ||
                 coordinates[0][1] !== coordinates[coordinates.length - 1][1])) {
                coordinates.push(coordinates[0]);
            }

            return {
                type: "Feature",
                geometry: {
                    type: "Polygon",
                    coordinates: [coordinates],
                },
            };
        }

        // Close autocomplete when clicking outside
        document.addEventListener('click', (e) => {
            if (!searchInput.contains(e.target) && !autocompleteList.contains(e.target)) {
                autocompleteList.classList.add('hidden');
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const activeBtn = document.querySelector('.btn-primary:not(:disabled):not(.hidden)');
                if (activeBtn) activeBtn.click();
            }
            if (e.key === 'Escape') {
                Object.values(modals).forEach(modal => modal.classList.remove('active'));
            }
        });

        // Prevent iOS zoom on input focus
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault();
            }
        });
    </script>
</body>
</html>